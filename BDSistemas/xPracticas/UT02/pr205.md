```python
import influxdb_client
from influxdb_client.client.write_api import SYNCHRONOUS
from influxdb_client.client.exceptions import InfluxDBError
from urllib3.exceptions import NewConnectionError

INFLUX_URL = "http://influxdb2:8086"
INFLUX_TOKEN = "MyInitialAdminToken0=payosno"

print("--- Iniciando conexión a InfluxDB ---")

client = None
try:

    client = influxdb_client.InfluxDBClient(
        url=INFLUX_URL,
        token=INFLUX_TOKEN,
        org="docs"
    )
    health = client.health()
    
    if health.status == "pass":
        print("[INFO] ¡Conexión exitosa!")
        print(f"[INFO]  Versión del servidor: {health.version}")
    else:
        print(f"[ERROR] Conexión fallida. Estado: {health.status}")
        print(f"[INFO] Mensaje: {health.message}")

except (InfluxDBError, NewConnectionError) as e:
    print("[ERROR] Error al conectar con InfluxDB:")
    print(f"   Detalle: {e}")
    
# finally:
#     # 3. Es buena práctica cerrar siempre el cliente
#     if client:
#         client.close()
#         print("--- Conexión cerrada ---")
```

    --- Iniciando conexión a InfluxDB ---
    [INFO] ¡Conexión exitosa!
    [INFO]  Versión del servidor: v2.7.12


# 1. Obtenemos las métricas de rendimiento de la máquina


```python
import psutil
import time

# Obtener estadísticas de uso de la máquina
def obtener_metricas(host_id):
    # Uso de cpu (promedio)
    cpu_usage = psutil.cpu_percent(interval=1)

    # Uso de RAM
    mem = psutil.virtual_memory()
    ram_used_gb = round(mem.used / (1024**3), 2)
    ram_percent = mem.percent

    # Uso de disco (en el punto de montaje)
    disk = psutil.disk_usage('/')
    disk_percent = disk.percent

    return {
        'host': host_id,
        'cpu_percent': cpu_usage,
        'ram_used_gb': ram_used_gb,
        'ram_percent': ram_percent,
        'disk_percent': disk_percent
    }
```

# 2. Modelo y escitura en lote


```python
from influxdb_client import Point
import time


try:
    print("[INFO] Press Ctrl+C to interrupt.")
    while(True):
        time.sleep(1)

        metrics = obtener_metricas("servidor-01") 

        p = Point("rednimiento_servidor") \
            .tag("host_id", metrics["host"]) \
            .tag("entorno", "producción") \
            .field("cpu_percent", metrics["cpu_percent"]) \
            .field("ram_percent", metrics["ram_percent"]) \
            .field("disck_percent", metrics["disk_percent"])
        
        write_api = client.write_api(write_api=SYNCHRONOUS)

        write_api.write(bucket="iot_data", org="docs", record=p)

        print(">> Escribiendo...")
except KeyboardInterrupt:
    write_api.close()
    print("Se interrumpió por el usuario")

```

    [INFO] Press Ctrl+C to interrupt.
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    >> Escribiendo...
    Se interrumpió por el usuario

